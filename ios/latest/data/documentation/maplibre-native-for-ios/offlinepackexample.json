{"variants":[{"traits":[{"interfaceLanguage":"occ"}],"paths":["\/documentation\/maplibre-native-for-ios\/offlinepackexample"]}],"abstract":[{"type":"text","text":"Download a region as an offline pack"}],"kind":"article","seeAlsoSections":[{"anchor":"Offline","identifiers":["doc:\/\/org.swift.MyProject\/documentation\/MapLibre-Native-for-iOS\/ManageOfflineRegionsExample"],"generated":true,"title":"Offline"}],"primaryContentSections":[{"kind":"content","content":[{"style":"note","name":"Note","content":[{"type":"paragraph","inlineContent":[{"text":"This example uses UIKit.","type":"text"}]}],"type":"aside"},{"inlineContent":[{"type":"text","text":"This example shows how to download a region as an offline pack. This particular example kicks off the download as soon as the map finished loading. For more control when and how to manage offline regions, see "},{"isActive":true,"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre-Native-for-iOS\/ManageOfflineRegionsExample"},{"type":"text","text":"."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"First, you need to define a "},{"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNTilePyramidOfflineRegion","isActive":true},{"type":"text","text":". Note that you should be conservative with your zoom level, because each individual tile in the tile pyramid will be individually downloaded. If you want to make a large area available offline, you should prepare a bundle, download this manually and use "},{"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage\/addContentsOfURL:withCompletionHandler:","isActive":true},{"type":"text","text":". However, this is outside of the scope of this example."}],"type":"paragraph"},{"inlineContent":[{"text":"You can pass along some user data \/ context with ","type":"text"},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage\/addPackForRegion:withContext:completionHandler:","type":"reference","isActive":true},{"text":". This can be read in the notififications that are emitted. You should listen for these notifications using the names defined by","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackProgressChangedNotification","isActive":true}]}]},{"content":[{"inlineContent":[{"isActive":true,"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackErrorNotification"},{"text":", and","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","isActive":true,"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackMaximumMapboxTilesReachedNotification"}]}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"as is shown in the example. Note that this last notification is a historical artifact, your tile provider may not have a maximum number of tiles you are allowed to store."}],"type":"paragraph"},{"code":["class OfflinePackExample: UIViewController, MLNMapViewDelegate {","    var mapView: MLNMapView!","    var progressView: UIProgressView!","    let jsonDecoder = JSONDecoder()","","    struct UserData: Codable {","        var name: String","    }","","    override func viewDidLoad() {","        super.viewDidLoad()","","        mapView = MLNMapView(frame: view.bounds, styleURL: AMERICANA_STYLE)","        mapView.autoresizingMask = [.flexibleWidth, .flexibleHeight]","        mapView.tintColor = .gray","        mapView.delegate = self","        view.addSubview(mapView)","","        mapView.setCenter(CLLocationCoordinate2D(latitude: 22.27933, longitude: 114.16281),","                          zoomLevel: 13, animated: false)","","        \/\/ Setup offline pack notification handlers.","        NotificationCenter.default.addObserver(self, selector: #selector(offlinePackProgressDidChange), name: NSNotification.Name.MLNOfflinePackProgressChanged, object: nil)","        NotificationCenter.default.addObserver(self, selector: #selector(offlinePackDidReceiveError), name: NSNotification.Name.MLNOfflinePackError, object: nil)","        NotificationCenter.default.addObserver(self, selector: #selector(offlinePackDidReceiveMaximumAllowedMapboxTiles), name: NSNotification.Name.MLNOfflinePackMaximumMapboxTilesReached, object: nil)","    }","","    func mapViewDidFinishLoadingMap(_: MLNMapView) {","        \/\/ Start downloading tiles and resources for z13-14.","        startOfflinePackDownload()","    }","","    override func viewDidDisappear(_ animated: Bool) {","        super.viewDidDisappear(animated)","","        \/\/ When leaving this view controller, suspend offline downloads.","        guard let packs = MLNOfflineStorage.shared.packs else { return }","        for pack in packs {","            if let userInfo = try? jsonDecoder.decode(UserData.self, from: pack.context) {","                print(\"Suspending download of offline pack: '\\(userInfo.name)'\")","            }","","            pack.suspend()","        }","    }","","    func startOfflinePackDownload() {","        \/\/ Create a region that includes the current viewport and any tiles needed to view it when zoomed further in.","        \/\/ Because tile count grows exponentially with the maximum zoom level, you should be conservative with your `toZoomLevel` setting.","        let region = MLNTilePyramidOfflineRegion(styleURL: mapView.styleURL, bounds: mapView.visibleCoordinateBounds, fromZoomLevel: mapView.zoomLevel, toZoomLevel: 14)","","        \/\/ Store some data for identification purposes alongside the downloaded resources.","        let jsonEncoder = JSONEncoder()","","        let userInfo = UserData(name: \"My Offline Pack\")","        let encodedUserInfo = try! jsonEncoder.encode(userInfo)","        print(encodedUserInfo)","","        \/\/ Create and register an offline pack with the shared offline storage object.","","        MLNOfflineStorage.shared.addPack(for: region, withContext: encodedUserInfo) { pack, error in","            guard error == nil else {","                \/\/ The pack couldn’t be created for some reason.","                print(\"Error: \\(error?.localizedDescription ?? \"unknown error\")\")","                return","            }","","            \/\/ Start downloading.","            pack!.resume()","        }","    }","","    \/\/ MARK: - MLNOfflinePack notification handlers","","    @objc func offlinePackProgressDidChange(notification: NSNotification) {","        \/\/ Get the offline pack this notification is regarding,","        \/\/ and the associated user info for the pack; in this case, `name = My Offline Pack`","        if let pack = notification.object as? MLNOfflinePack,","           let userInfo = try? jsonDecoder.decode(UserData.self, from: pack.context)","        {","            let progress = pack.progress","            \/\/ or notification.userInfo![MLNOfflinePackProgressUserInfoKey]!.MLNOfflinePackProgressValue","            let completedResources = progress.countOfResourcesCompleted","            let expectedResources = progress.countOfResourcesExpected","","            \/\/ Calculate current progress percentage.","            let progressPercentage = Float(completedResources) \/ Float(expectedResources)","","            \/\/ Setup the progress bar.","            if progressView == nil {","                progressView = UIProgressView(progressViewStyle: .default)","                let frame = view.bounds.size","                progressView.frame = CGRect(x: frame.width \/ 4, y: frame.height * 0.75, width: frame.width \/ 2, height: 10)","                view.addSubview(progressView)","            }","","            progressView.progress = progressPercentage","","            \/\/ If this pack has finished, print its size and resource count.","            if completedResources == expectedResources {","                let byteCount = ByteCountFormatter.string(fromByteCount: Int64(pack.progress.countOfBytesCompleted), countStyle: ByteCountFormatter.CountStyle.memory)","                print(\"Offline pack “\\(userInfo.name)” completed: \\(byteCount), \\(completedResources) resources\")","            } else {","                \/\/ Otherwise, print download\/verification progress.","                print(\"Offline pack “\\(userInfo.name)” has \\(completedResources) of \\(expectedResources) resources — \\(String(format: \"%.2f\", progressPercentage * 100))%.\")","            }","        }","    }","","    @objc func offlinePackDidReceiveError(notification: NSNotification) {","        if let pack = notification.object as? MLNOfflinePack,","           let userInfo = try? jsonDecoder.decode(UserData.self, from: pack.context),","           let error = notification.userInfo?[MLNOfflinePackUserInfoKey.error] as? NSError","        {","            print(\"Offline pack “\\(userInfo.name)” received error: \\(error.localizedFailureReason ?? \"unknown error\")\")","        }","    }","","    @objc func offlinePackDidReceiveMaximumAllowedMapboxTiles(notification: NSNotification) {","        if let pack = notification.object as? MLNOfflinePack,","           let userInfo = try? jsonDecoder.decode(UserData.self, from: pack.context),","           let maximumCount = (notification.userInfo?[MLNOfflinePackUserInfoKey.maximumCount] as AnyObject).uint64Value","        {","            print(\"Offline pack “\\(userInfo.name)” reached limit of \\(maximumCount) tiles.\")","        }","    }","}"],"syntax":"swift","type":"codeListing"}]}],"metadata":{"modules":[{"name":"MapLibre"}],"roleHeading":"Article","role":"article","title":"Download Offline Pack"},"identifier":{"url":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre-Native-for-iOS\/OfflinePackExample","interfaceLanguage":"occ"},"schemaVersion":{"minor":3,"major":0,"patch":0},"hierarchy":{"paths":[["doc:\/\/org.swift.MyProject\/documentation\/MapLibre"]]},"sections":[],"references":{"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflineStorage/addPackForRegion:withContext:completionHandler:":{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage\/addPackForRegion:withContext:completionHandler:","abstract":[{"text":"Creates and registers an offline pack that downloads the resources needed to","type":"text"},{"text":" ","type":"text"},{"text":"use the given region offline.","type":"text"}],"fragments":[{"kind":"text","text":"- "},{"kind":"identifier","text":"addPackForRegion:withContext:completionHandler:"}],"title":"addPackForRegion:withContext:completionHandler:","navigatorTitle":[{"kind":"identifier","text":"addPackForRegion:withContext:completionHandler:"}],"url":"\/documentation\/maplibre\/mlnofflinestorage\/addpackforregion:withcontext:completionhandler:","kind":"symbol","type":"topic","role":"symbol"},"doc://org.swift.MyProject/documentation/MapLibre/MLNTilePyramidOfflineRegion":{"title":"MLNTilePyramidOfflineRegion","url":"\/documentation\/maplibre\/mlntilepyramidofflineregion","abstract":[{"type":"text","text":"An offline region defined by a style URL, geographic coordinate bounds, and"},{"type":"text","text":" "},{"type":"text","text":"range of zoom levels."}],"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNTilePyramidOfflineRegion","fragments":[{"text":"MLNTilePyramidOfflineRegion","kind":"identifier"}],"kind":"symbol","type":"topic","role":"symbol"},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflineStorage":{"title":"MLNOfflineStorage","kind":"symbol","abstract":[{"type":"text","text":"MLNOfflineStorage implements a singleton (shared object) that manages offline"},{"type":"text","text":" "},{"type":"text","text":"packs and ambient caching. All of this class’s instance methods are asynchronous,"},{"type":"text","text":" "},{"type":"text","text":"reflecting the fact that offline resources are stored in a database. The shared"},{"type":"text","text":" "},{"type":"text","text":"object maintains a canonical collection of offline packs in its "},{"type":"codeVoice","code":"packs"},{"type":"text","text":" property."}],"fragments":[{"text":"MLNOfflineStorage","kind":"identifier"}],"type":"topic","url":"\/documentation\/maplibre\/mlnofflinestorage","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage","role":"symbol"},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflineStorage/addContentsOfURL:withCompletionHandler:":{"title":"addContentsOfURL:withCompletionHandler:","kind":"symbol","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage\/addContentsOfURL:withCompletionHandler:","role":"symbol","navigatorTitle":[{"text":"addContentsOfURL:withCompletionHandler:","kind":"identifier"}],"type":"topic","fragments":[{"text":"- ","kind":"text"},{"text":"addContentsOfURL:withCompletionHandler:","kind":"identifier"}],"abstract":[{"type":"text","text":"Adds the offline packs located at the given URL to offline storage."}],"url":"\/documentation\/maplibre\/mlnofflinestorage\/addcontentsofurl:withcompletionhandler:"},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflinePackErrorNotification":{"type":"topic","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackErrorNotification","role":"symbol","kind":"symbol","abstract":[{"type":"text","text":"Posted by the shared "},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage","type":"reference","isActive":true},{"type":"text","text":" object whenever an "},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage","type":"reference","isActive":true},{"type":"text","text":" "},{"type":"text","text":"object encounters an error while downloading. The error may be recoverable and"},{"type":"text","text":" "},{"type":"text","text":"may not warrant the user’s attention. For example, the pack’s implementation"},{"type":"text","text":" "},{"type":"text","text":"may attempt to re-request failed resources based on an exponential backoff"},{"type":"text","text":" "},{"type":"text","text":"strategy or upon the restoration of network access."}],"title":"MLNOfflinePackErrorNotification","url":"\/documentation\/maplibre\/mlnofflinepackerrornotification","fragments":[{"kind":"identifier","text":"MLNOfflinePackErrorNotification"}]},"doc://org.swift.MyProject/documentation/MapLibre":{"kind":"symbol","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre","url":"\/documentation\/maplibre","abstract":[{"text":"Powerful, free and open-source mapping toolkit with full control over data sources and styling.","type":"text"}],"title":"MapLibre","role":"collection","type":"topic"},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflinePackMaximumMapboxTilesReachedNotification":{"kind":"symbol","role":"symbol","type":"topic","title":"MLNOfflinePackMaximumMapboxTilesReachedNotification","abstract":[{"type":"text","text":"Posted by the shared "},{"isActive":true,"type":"reference","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage"},{"type":"text","text":" object when the maximum number of"},{"type":"text","text":" "},{"type":"text","text":"tiles has been downloaded and stored on the current device."}],"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackMaximumMapboxTilesReachedNotification","url":"\/documentation\/maplibre\/mlnofflinepackmaximummapboxtilesreachednotification","fragments":[{"kind":"identifier","text":"MLNOfflinePackMaximumMapboxTilesReachedNotification"}]},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflinePack":{"title":"MLNOfflinePack","abstract":[{"type":"text","text":"An "},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePack","type":"reference","isActive":true},{"type":"text","text":" represents a collection of resources necessary for viewing"},{"type":"text","text":" "},{"type":"text","text":"a region offline to a local database."}],"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePack","url":"\/documentation\/maplibre\/mlnofflinepack","role":"symbol","kind":"symbol","type":"topic","fragments":[{"kind":"identifier","text":"MLNOfflinePack"}]},"doc://org.swift.MyProject/documentation/MapLibre/MLNOfflinePackProgressChangedNotification":{"type":"topic","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePackProgressChangedNotification","kind":"symbol","role":"symbol","title":"MLNOfflinePackProgressChangedNotification","abstract":[{"text":"Posted by the shared ","type":"text"},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflineStorage","isActive":true,"type":"reference"},{"text":" object when an ","type":"text"},{"identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre\/MLNOfflinePack","isActive":true,"type":"reference"},{"text":" ","type":"text"},{"text":"object’s progress changes. The progress may change due to a resource being","type":"text"},{"text":" ","type":"text"},{"text":"downloaded or because the pack discovers during the download that more","type":"text"},{"text":" ","type":"text"},{"text":"resources are required for offline viewing. This notification is posted","type":"text"},{"text":" ","type":"text"},{"text":"whenever any field in the ","type":"text"},{"code":"progress","type":"codeVoice"},{"text":" property changes.","type":"text"}],"fragments":[{"kind":"identifier","text":"MLNOfflinePackProgressChangedNotification"}],"url":"\/documentation\/maplibre\/mlnofflinepackprogresschangednotification"},"doc://org.swift.MyProject/documentation/MapLibre-Native-for-iOS/ManageOfflineRegionsExample":{"kind":"article","identifier":"doc:\/\/org.swift.MyProject\/documentation\/MapLibre-Native-for-iOS\/ManageOfflineRegionsExample","url":"\/documentation\/maplibre-native-for-ios\/manageofflineregionsexample","abstract":[{"text":"Query, delete and download offline regions","type":"text"}],"type":"topic","title":"Manage Offline Regions","role":"article"}}}